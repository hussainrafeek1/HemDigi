<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Pharmacy Workorder List - Responsive & Friendly</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background: #f8f9fa;
      min-height: 100vh;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }
    .container {
      max-width: 1200px;
    }
    h2 {
      font-weight: 700;
      margin-bottom: 1rem;
    }
    .last-updated {
      font-size: 0.85rem;
      color: #6c757d;
      margin-bottom: 1.5rem;
      user-select: none;
    }
    /* Sticky tabs */
    #mainTabs {
      position: sticky;
      top: 0;
      z-index: 1050;
      background: #fff;
      box-shadow: 0 2px 4px rgb(0 0 0 / 0.1);
      margin-bottom: 1rem;
    }
    /* Filters */
    .filters-row {
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .filters-row input[type="text"],
    .filters-row input[type="date"] {
      min-width: 150px;
      max-width: 250px;
      transition: max-width 0.3s ease;
    }
    @media (max-width: 576px) {
      .filters-row input[type="text"],
      .filters-row input[type="date"] {
        max-width: 100%;
      }
    }
    .btn {
      min-width: 110px;
    }
    /* Table */
    #dataTable {
      box-shadow: 0 0 8px rgba(0,0,0,0.05);
      transition: box-shadow 0.3s ease;
    }
    #dataTable tbody tr:hover {
      background-color: #e9f5ff;
      cursor: pointer;
      transition: background-color 0.25s ease;
    }
    /* Empty State */
    .empty-state {
      font-size: 1.1rem;
      font-weight: 500;
      color: #868e96;
      padding: 2rem;
      text-align: center;
      background: #fff;
      border-radius: 8px;
      box-shadow: inset 0 0 8px #eee;
      margin-top: 1rem;
    }
    /* Dashboard */
    .dashboard {
      background-color: #fff;
      padding: 1.25rem;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgb(0 123 255 / 0.15);
      margin-bottom: 2rem;
      user-select: none;
    }
    .dashboard h5 {
      margin-bottom: 0.75rem;
      color: #0d6efd;
      font-weight: 600;
    }
    .dashboard p {
      font-size: 2.25rem;
      font-weight: 700;
      margin: 0;
      user-select: text;
    }
    /* Chart container with horizontal scroll on small screens */
    .charts-wrapper {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      overflow-x: auto;
      padding-bottom: 1rem;
      scroll-behavior: smooth;
    }
    .chart-container {
      flex: 1 1 45%;
      min-width: 320px;
      background: #fff;
      border-radius: 10px;
      padding: 1rem 1rem 1.5rem;
      box-shadow: 0 4px 12px rgb(0 0 0 / 0.05);
      transition: box-shadow 0.3s ease;
    }
    .chart-container h6 {
      text-align: center;
      font-weight: 600;
      color: #212529;
      margin-bottom: 0.8rem;
      user-select: none;
    }
    .chart-container:hover {
      box-shadow: 0 8px 20px rgb(0 0 0 / 0.12);
    }
    /* Buttons hover */
    button.btn:hover {
      opacity: 0.9;
      transition: opacity 0.2s ease;
    }
    /* Modal improvements */
    .modal-content {
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      transition: box-shadow 0.3s ease;
    }
    .modal-header {
      border-bottom: 2px solid #e9ecef;
    }
    .modal-title {
      font-weight: 700;
      color: #0d6efd;
    }
    /* Toast */
    .toast {
      border-radius: 0.5rem;
      font-weight: 600;
      font-size: 1rem;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
      user-select: none;
    }
    /* Loading Spinner overlay */
    #loadingOverlay {
      position: fixed;
      top: 0; left: 0; bottom: 0; right: 0;
      background: rgba(255,255,255,0.75);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1060;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    #loadingOverlay.show {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body>
<audio id="notificationSound" preload="auto">
  <source src="https://cdn.uppbeat.io/audio-files/63fdffb02a4e0d1d7ab0b67b947853c6/63f1302a46db8063b45acf2df2abaec3/78af9b09712bffd2b48e92fa7f08f071/STREAMING-level-complete-mobile-game-app-locran-1-00-06.mp3=" type="mp3">
</audio>

<div class="container my-4">
<div id="clickToEnable" class="alert alert-info text-center" style="display: none;">
  ðŸ”” Click anywhere to enable sound notifications
</div>

  <h2>Pharmacy Workorder List</h2>
  <p id="lastUpdated" class="last-updated">Last updated: --</p>

  <!-- Main Tabs -->
  <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist" aria-label="Main Tabs">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboardTab" type="button" role="tab" aria-controls="dashboardTab" aria-selected="true">Dashboard</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="workorder-tab" data-bs-toggle="tab" data-bs-target="#workorderTab" type="button" role="tab" aria-controls="workorderTab" aria-selected="false">Workorders</button>
    </li>
  </ul>

  <div class="tab-content" id="mainTabsContent">
    <!-- Dashboard Tab -->
    <div class="tab-pane fade show active" id="dashboardTab" role="tabpanel" aria-labelledby="dashboard-tab" tabindex="0">

      <!-- Date Filters for dashboard -->
      <div class="d-flex filters-row justify-content-center mb-3" role="region" aria-label="Dashboard date filters">
        <input type="date" id="dashFromDate" class="form-control" style="max-width: 180px;" aria-label="Dashboard From date" />
        <input type="date" id="dashToDate" class="form-control" style="max-width: 180px;" aria-label="Dashboard To date" />
        <button id="btnDashClearFilter" class="btn btn-outline-secondary" aria-label="Clear dashboard date filters">Clear Filter</button>
      </div>

      <!-- Summary -->
      <div class="dashboard row text-center mb-4" aria-live="polite" aria-atomic="true" aria-relevant="text">
        <div class="col-4 col-md-4">
          <h5>Total</h5>
          <p id="dashTotal" class="fw-bold fs-4 text-primary">0</p>
        </div>
        <div class="col-4 col-md-4">
          <h5>Pending</h5>
          <p id="dashPending" class="fw-bold fs-4 text-warning">0</p>
        </div>
        <div class="col-4 col-md-4">
          <h5>Completed</h5>
          <p id="dashCompleted" class="fw-bold fs-4 text-success">0</p>
        </div>
      </div>

      <!-- All charts visible -->
      <div class="charts-wrapper" role="region" aria-label="Dashboard charts">
        <div class="chart-container">
          <h6>Summary Pie Chart</h6>
          <canvas id="summaryPieChart" height="280" aria-label="Summary pie chart" role="img"></canvas>
          <div id="summaryPieChartEmpty" class="text-center text-muted" style="display:none;">No data available</div>
        </div>
        <div class="chart-container">
          <h6>Daily Trend Line Chart</h6>
          <canvas id="dailyTrendChart" height="280" aria-label="Daily trend line chart" role="img"></canvas>
          <div id="dailyTrendChartEmpty" class="text-center text-muted" style="display:none;">No data available</div>
        </div>
        <div class="chart-container">
          <h6>Doctor-wise Bar Chart</h6>
          <canvas id="doctorBarChart" height="280" aria-label="Doctor wise bar chart" role="img"></canvas>
          <div id="doctorBarChartEmpty" class="text-center text-muted" style="display:none;">No data available</div>
        </div>
        <div class="chart-container">
          <h6>Status Over Time Line Chart</h6>
          <canvas id="statusOverTimeChart" height="280" aria-label="Status over time line chart" role="img"></canvas>
          <div id="statusOverTimeChartEmpty" class="text-center text-muted" style="display:none;">No data available</div>
        </div>
      </div>
    </div>

    <!-- Workorders Tab -->
    <div class="tab-pane fade" id="workorderTab" role="tabpanel" aria-labelledby="workorder-tab" tabindex="0">
      <!-- Filters -->
      <div class="d-flex filters-row align-items-center mb-3" role="region" aria-label="Workorders filters">
        <input type="text" id="searchInput" class="form-control" style="max-width: 220px;" placeholder="Search by Title or Doctor" aria-label="Search by Title or Doctor" />
        <input type="date" id="fromDate" class="form-control" style="max-width: 180px;" aria-label="From date" />
        <input type="date" id="toDate" class="form-control" style="max-width: 180px;" aria-label="To date" />
        <button id="btnRefresh" class="btn btn-primary" aria-label="Refresh data">Refresh</button>
        <button id="btnClearFilter" class="btn btn-outline-secondary" aria-label="Clear all filters">Clear Filter</button>
      </div>

      <!-- Status Tabs -->
      <ul class="nav nav-tabs mb-3" id="statusTabs" role="tablist" aria-label="Status filter tabs">
        <li class="nav-item" role="presentation"><button class="nav-link active" data-status="" type="button" aria-selected="true" aria-label="Show all workorders">All</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" data-status="Pending" type="button" aria-selected="false" aria-label="Show pending workorders">Pending</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" data-status="Completed" type="button" aria-selected="false" aria-label="Show completed workorders">Completed</button></li>
      </ul>

      <!-- Table -->
      <div class="table-responsive shadow-sm rounded">
        <table id="dataTable" class="table table-bordered table-striped mb-0">
          <thead class="table-light">
            <tr>
              <th>Title</th>
              <th>Doctor</th>
              <th>Status</th>
              <th>Prescription</th>
              <th>Created Time</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tableBody" role="rowgroup"></tbody>
        </table>
      </div>
      <div id="emptyState" class="empty-state" style="display: none;">No records found.</div>
    </div>
  </div>
</div>

<!-- Loading Spinner Overlay -->
<div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(255,255,255,0.7); z-index:9999; justify-content:center; align-items:center;">
  <div class="spinner-border text-primary" role="status"></div>
</div>


<!-- Modal -->
<div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="itemForm">
        <div class="modal-header">
          <h5 class="modal-title" id="itemModalLabel">Edit Item</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="inputTitle" class="form-label">Title</label>
            <input type="text" id="inputTitle" class="form-control" required aria-required="true" />
          </div>
          <div class="mb-3">
            <label for="inputDoctor" class="form-label">Doctor</label>
            <input type="text" id="inputDoctor" class="form-control" required aria-required="true" />
          </div>
          <div class="mb-3">
            <label for="inputStatus" class="form-label">Status</label>
            <select id="inputStatus" class="form-select" required aria-required="true" aria-describedby="statusHelp">
              <option value="">Select</option>
              <option value="Pending">Pending</option>
              <option value="Completed">Completed</option>
            </select>
            <small id="statusHelp" class="form-text text-muted">Choose workorder status</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary" aria-label="Save changes">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Cancel editing">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="toast-container"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

document.addEventListener('click', () => {
  canPlaySound = true;
  document.getElementById('clickToEnable').style.display = 'none';
}, { once: true });

window.onload = () => {
  if (!canPlaySound) {
    document.getElementById('clickToEnable').style.display = 'block';
  }
};


  const getItemsUrl = "https://prod-85.southeastasia.logic.azure.com:443/workflows/52c49cc8baed41e5af8e47ad79c76061/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Und9bIA8BdZnBaVIx8-z87n3ytcYh6FVGkFsVF6RzUI";
  const updateItemUrl = "https://prod-33.southeastasia.logic.azure.com:443/workflows/780298bb3d184582ac7193bf0ff29012/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=IdH9jAuK_ZQKQhnS71agVuEBkOrwn5A4fEqikHM3Bso";
  const sharePointBaseUrl = "https://hemascol.sharepoint.com";

  let editingItemId = null;
  let allItems = [];
  let currentStatusTab = '';
  const modal = new bootstrap.Modal(document.getElementById('itemModal'));
  const loadingOverlay = document.getElementById('loadingOverlay');

  // Chart instances
  let summaryPieChart = null;
  let dailyTrendChart = null;
  let doctorBarChart = null;
  let statusOverTimeChart = null;

  function showLoading(show) {
    if(show) loadingOverlay.classList.add('show');
    else loadingOverlay.classList.remove('show');
  }

  // Toast helper
  function showToast(msg, isError = false) {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${isError ? 'danger' : 'success'} border-0 show`;
    toast.role = 'alert';
    toast.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div></div>`;
    document.querySelector('.toast-container').appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  // Fetch items from API
  async function fetchItems() {
    try {
      showLoading(true);
      const res = await fetch(getItemsUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
      const data = await res.json();
      showLoading(false);
      return data?.d?.results || data?.results || [];
    } catch {
      showLoading(false);
      showToast("Failed to load items", true);
      return [];
    }
  }

  // Attachments links HTML
  function getAttachmentLinks(item) {
    if (item.Attachments && item.AttachmentFiles?.results?.length) {
      return item.AttachmentFiles.results.map(f => {
        const url = sharePointBaseUrl + encodeURI(f.ServerRelativeUrl);
        return `<a href="${url}" target="_blank" rel="noopener noreferrer">${f.FileName || 'Attachment'}</a>`;
      }).join(", ");
    }
    return '';
  }

  // Build workorder table rows
  function buildTableBody(items) {
    const tbody = document.getElementById('tableBody');
    const empty = document.getElementById('emptyState');
    tbody.innerHTML = '';
    if (!items.length) {
      empty.style.display = 'block';
      return;
    }
    empty.style.display = 'none';

    items.forEach(item => {
      const tr = document.createElement('tr');
      tr.setAttribute('tabindex', '0');
      tr.innerHTML = `
        <td>${item.Title || ''}</td>
        <td>${item.Doctor || ''}</td>
        <td>${item.Status || ''}</td>
        <td>${getAttachmentLinks(item)}</td>
        <td>${item.Created ? new Date(item.Created).toLocaleString() : ''}</td>`;
      const td = document.createElement('td');
      const btn = document.createElement('button');
      btn.className = 'btn btn-sm btn-warning';
      btn.textContent = 'Edit';
      btn.setAttribute('aria-label', `Edit workorder ${item.Title || ''}`);
      btn.onclick = () => startEditItem(item);
      td.appendChild(btn);
      tr.appendChild(td);
      tbody.appendChild(tr);
    });
  }

  // Edit modal
  function startEditItem(item) {
    editingItemId = item.ID;
    document.getElementById('inputTitle').value = item.Title || '';
    document.getElementById('inputDoctor').value = item.Doctor || '';
    document.getElementById('inputStatus').value = item.Status || '';
    modal.show();
  }

  // Submit form update
  async function submitForm(e) {
    e.preventDefault();
    const formData = {
      ID: editingItemId,
      Title: document.getElementById('inputTitle').value.trim(),
      Doctor: document.getElementById('inputDoctor').value.trim(),
      Status: document.getElementById('inputStatus').value
    };
    try {
      showLoading(true);
      const res = await fetch(updateItemUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });
      showLoading(false);
      if (!res.ok) throw new Error();
      showToast("Updated successfully");
      modal.hide();
      editingItemId = null;
      await loadData();
    } catch {
      showLoading(false);
      showToast("Update error", true);
    }
  }

  // Update dashboard summary counts
  function updateDashboardSummary(items) {
    document.getElementById("dashTotal").textContent = items.length;
    document.getElementById("dashPending").textContent = items.filter(i => i.Status === "Pending").length;
    document.getElementById("dashCompleted").textContent = items.filter(i => i.Status === "Completed").length;
  }

  // Update all charts data
  function updateDashboardCharts(items) {
    updateDashboardSummary(items);
    updateSummaryPieChart(items);
    updateDailyTrendChart(items);
    updateDoctorBarChart(items);
    updateStatusOverTimeChart(items);
  }

  // Helpers for filtering by date range
  function filterItemsByDateRange(items, fromDate, toDate) {
    const from = fromDate ? new Date(fromDate) : null;
    const to = toDate ? new Date(toDate) : null;
    if(to) to.setHours(23,59,59,999);

    return items.filter(i => {
      if (!i.Created) return false;
      const created = new Date(i.Created);
      if (from && created < from) return false;
      if (to && created > to) return false;
      return true;
    });
  }

  // Update Pie Chart
  function updateSummaryPieChart(items) {
    const ctx = document.getElementById('summaryPieChart').getContext('2d');
    const containerEmpty = document.getElementById('summaryPieChartEmpty');
    const statusCounts = items.reduce((acc, i) => {
      const s = i.Status || 'Other';
      acc[s] = (acc[s] || 0) + 1;
      return acc;
    }, {});
    const labels = Object.keys(statusCounts);
    const data = Object.values(statusCounts);
    if(summaryPieChart) summaryPieChart.destroy();

    if (data.length === 0) {
      containerEmpty.style.display = 'block';
      return;
    }
    containerEmpty.style.display = 'none';

    summaryPieChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels,
        datasets: [{
          data,
          backgroundColor: ['#ffc107','#198754','#6c757d','#0d6efd','#dc3545'],
          hoverOffset: 20
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom', labels: {boxWidth: 14, padding: 12} }
        }
      }
    });
  }

  // Update Daily Trend Line Chart
  function updateDailyTrendChart(items) {
    const ctx = document.getElementById('dailyTrendChart').getContext('2d');
    const containerEmpty = document.getElementById('dailyTrendChartEmpty');
    if(dailyTrendChart) dailyTrendChart.destroy();

    // Count by date
    const countsByDate = {};
    items.forEach(item => {
      if(!item.Created) return;
      const day = new Date(item.Created).toISOString().split('T')[0];
      countsByDate[day] = (countsByDate[day] || 0) + 1;
    });
    const labels = Object.keys(countsByDate).sort();
    const data = labels.map(d => countsByDate[d]);

    if (data.length === 0) {
      containerEmpty.style.display = 'block';
      return;
    }
    containerEmpty.style.display = 'none';

    dailyTrendChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Workorders',
          data,
          fill: true,
          backgroundColor: 'rgba(13, 110, 253, 0.3)',
          borderColor: '#0d6efd',
          tension: 0.25,
          pointRadius: 4
        }]
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        scales: {
          x: { title: { display: true, text: 'Date' }},
          y: { beginAtZero: true, title: { display: true, text: 'Count' }, precision: 0 }
        },
        plugins: {
          legend: { display: true, position: 'top' }
        }
      }
    });
  }

  // Update Doctor-wise Bar Chart
  function updateDoctorBarChart(items) {
    const ctx = document.getElementById('doctorBarChart').getContext('2d');
    const containerEmpty = document.getElementById('doctorBarChartEmpty');
    if(doctorBarChart) doctorBarChart.destroy();

    const countsByDoctor = {};
    items.forEach(i => {
      const doc = i.Doctor || 'Unknown';
      countsByDoctor[doc] = (countsByDoctor[doc] || 0) + 1;
    });
    const labels = Object.keys(countsByDoctor).sort();
    const data = labels.map(d => countsByDoctor[d]);

    if (data.length === 0) {
      containerEmpty.style.display = 'block';
      return;
    }
    containerEmpty.style.display = 'none';

    doctorBarChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Workorders',
          data,
          backgroundColor: '#0d6efd'
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: { title: { display: true, text: 'Doctor' }},
          y: { beginAtZero: true, title: { display: true, text: 'Count' }, precision: 0 }
        },
        plugins: {
          legend: { display: false }
        }
      }
    });
  }

  // Update Status Over Time Chart
  function updateStatusOverTimeChart(items) {
    const ctx = document.getElementById('statusOverTimeChart').getContext('2d');
    const containerEmpty = document.getElementById('statusOverTimeChartEmpty');
    if(statusOverTimeChart) statusOverTimeChart.destroy();

    const statuses = ['Pending', 'Completed', 'Other'];
    const countsByDateStatus = {};
    items.forEach(item => {
      if (!item.Created) return;
      const dayStr = new Date(item.Created).toISOString().split('T')[0];
      let status = item.Status || 'Other';
      if (!statuses.includes(status)) status = 'Other';
      if (!countsByDateStatus[dayStr]) countsByDateStatus[dayStr] = { Pending:0, Completed:0, Other:0 };
      countsByDateStatus[dayStr][status]++;
    });
    const statusDates = Object.keys(countsByDateStatus).sort();

    const datasetsStatus = statuses.map((status, idx) => ({
      label: status,
      data: statusDates.map(date => countsByDateStatus[date][status] || 0),
      borderColor: ['#ffc107','#198754','#6c757d'][idx],
      backgroundColor: ['rgba(255, 193, 7, 0.3)', 'rgba(25, 135, 84, 0.3)', 'rgba(108, 117, 125, 0.3)'][idx],
      fill: true,
      tension: 0.3,
      pointRadius: 3
    }));

    if (statusDates.length === 0) {
      containerEmpty.style.display = 'block';
      return;
    }
    containerEmpty.style.display = 'none';

    statusOverTimeChart = new Chart(ctx, {
      type: 'line',
      data: { labels: statusDates, datasets: datasetsStatus },
      options: {
        responsive: true,
        scales: {
          x: { title: { display: true, text: 'Date' } },
          y: { beginAtZero: true, title: { display: true, text: 'Count' }, precision: 0 }
        },
        plugins: { legend: { position: 'top' } }
      }
    });
  }

  // Filters and render workorder table
  function applyFiltersAndRender() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const from = new Date(document.getElementById('fromDate').value);
    const to = new Date(document.getElementById('toDate').value);
    to.setHours(23, 59, 59, 999);
    let filtered = allItems;

    if (currentStatusTab) filtered = filtered.filter(i => i.Status === currentStatusTab);
    if (search) filtered = filtered.filter(i =>
      (i.Title || '').toLowerCase().includes(search) ||
      (i.Doctor || '').toLowerCase().includes(search)
    );
    if (!isNaN(from)) filtered = filtered.filter(i => new Date(i.Created) >= from);
    if (!isNaN(to)) filtered = filtered.filter(i => new Date(i.Created) <= to);

    buildTableBody(filtered);
    updateDashboardSummary(filtered);
  }

  // Clear filters for workorders tab
  function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('fromDate').value = '';
    document.getElementById('toDate').value = '';
    currentStatusTab = '';
    document.querySelectorAll('#statusTabs button').forEach(b => b.classList.remove('active'));
    document.querySelector('#statusTabs button[data-status=""]').classList.add('active');
    applyFiltersAndRender();
  }

  // Clear filters for dashboard tab
  function clearDashboardFilters() {
    document.getElementById('dashFromDate').value = '';
    document.getElementById('dashToDate').value = '';
    updateDashboardCharts(allItems);
  }

  // Load data & update UI
let previousItemIDs = new Set();

async function loadData(showLoadingAnimation = true) {
  if (showLoadingAnimation) showLoading(true); // Only show spinner when true
  const newItems = await fetchItems();
  if (showLoadingAnimation) showLoading(false);

  // Check for new items by comparing IDs
  const newIDs = new Set(newItems.map(item => item.ID));
  let isNewItem = false;
  for (let id of newIDs) {
    if (!previousItemIDs.has(id)) {
      isNewItem = true;
      break;
    }
  }

 if (isNewItem && previousItemIDs.size > 0) {
  if (canPlaySound) {
    document.getElementById("notificationSound").play();
  }
  showToast("New workorder received!", false);
}


  previousItemIDs = newIDs;
  allItems = newItems;

  updateDashboardByDateFilter?.();

  if (document.getElementById('workorderTab').classList.contains('active')) {
    applyFiltersAndRender();
  }

  document.getElementById("lastUpdated").textContent = "Last updated: " + new Date().toLocaleString();
}


  // Update dashboard charts based on date filter
  function updateDashboardByDateFilter() {
    const fromDate = document.getElementById('dashFromDate').value;
    const toDate = document.getElementById('dashToDate').value;
    const filtered = filterItemsByDateRange(allItems, fromDate, toDate);
    updateDashboardCharts(filtered);
  }

  // Event listeners
  document.getElementById('searchInput').addEventListener('input', applyFiltersAndRender);
  document.getElementById('fromDate').addEventListener('change', applyFiltersAndRender);
  document.getElementById('toDate').addEventListener('change', applyFiltersAndRender);
  document.getElementById('btnRefresh').addEventListener('click', () => loadData(true));
  document.getElementById('btnClearFilter').addEventListener('click', clearFilters);
  document.getElementById('btnDashClearFilter').addEventListener('click', clearDashboardFilters);
  document.querySelectorAll('#statusTabs button').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('#statusTabs button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentStatusTab = btn.getAttribute('data-status');
      applyFiltersAndRender();
    };
  });
  document.getElementById('itemForm').addEventListener('submit', submitForm);
  document.getElementById('dashFromDate').addEventListener('change', updateDashboardByDateFilter);
  document.getElementById('dashToDate').addEventListener('change', updateDashboardByDateFilter);

  // Auto-refresh every 5 seconds if tab active
setInterval(() => {
  if (document.hasFocus()) {
    loadData(false); // <--- disable spinner
  }
}, 5000);

  // Initial load
  window.onload = () => {
    loadData();
  };

function showLoading(show) {
  document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
}

document.getElementById("notificationSound").play();

</script>
</body>
</html>
