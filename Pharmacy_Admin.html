<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pharmacy Workorder List</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 1055; }
    .empty-state { text-align: center; color: gray; padding: 20px; }
  </style>
</head>
<body>
  <div class="container my-4">
    <h2>Pharmacy Workorder List</h2>

    <!-- Search + Filter + Buttons -->
    <div class="mb-3 d-flex flex-wrap align-items-center gap-2">
      <input type="text" id="searchInput" class="form-control" style="max-width: 250px;" placeholder="Search by Title or Doctor" />
      
      <select id="filterStatus" class="form-select" style="max-width: 180px;">
        <option value="">All Statuses</option>
        <option value="Pending">Pending</option>
        <option value="Completed">Completed</option>
      </select>
      
      <button id="btnRefresh" class="btn btn-primary">Refresh Data</button>
      <button id="btnAddNew" class="btn btn-success">Add New</button>
    </div>

    <!-- Status Tabs -->
    <ul class="nav nav-tabs mb-3" id="statusTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" data-status="" type="button">All</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-status="Pending" type="button">Pending</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-status="Completed" type="button">Completed</button>
      </li>
    </ul>

    <table id="dataTable" class="table table-bordered table-striped">
      <thead>
        <tr>
          <th>Title</th>
          <th>Doctor</th>
          <th>Status</th>
          <th>Attachment</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
    <div id="emptyState" class="empty-state" style="display: none;">No transport requests found.</div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="itemForm">
          <div class="modal-header">
            <h5 class="modal-title" id="itemModalLabel">Add New Item</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="inputTitle" class="form-label">Title</label>
              <input type="text" id="inputTitle" class="form-control" required />
            </div>
            <div class="mb-3">
              <label for="inputDoctor" class="form-label">Doctor</label>
              <input type="text" id="inputDoctor" class="form-control" required />
            </div>
            <div class="mb-3">
              <label for="inputStatus" class="form-label">Status</label>
              <select id="inputStatus" class="form-select" required>
                <option value="">Select</option>
                <option value="Pending">Pending</option>
                <option value="Completed">Completed</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="inputAttachment" class="form-label">Attachment</label>
              <input type="file" id="inputAttachment" class="form-control" />
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Save</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="toast-container"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const getItemsUrl = "https://prod-85.southeastasia.logic.azure.com:443/workflows/52c49cc8baed41e5af8e47ad79c76061/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Und9bIA8BdZnBaVIx8-z87n3ytcYh6FVGkFsVF6RzUI";
    const addItemUrl = "https://prod-64.southeastasia.logic.azure.com:443/workflows/8f18d6f06407418bb87e1cb3f9ef4b15/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=x4LVlrP4U6mLY-bsbv9634kCA8V-X1H7GEiPiTyg1ls";
    const updateItemUrl = "https://prod-33.southeastasia.logic.azure.com:443/workflows/780298bb3d184582ac7193bf0ff29012/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=IdH9jAuK_ZQKQhnS71agVuEBkOrwn5A4fEqikHM3Bso";
    const deleteItemUrl = "https://prod-78.southeastasia.logic.azure.com:443/workflows/adcd951cf533489793ec9e05548fe5e5/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=pY5o780bRRA3qYY0gZiWZF5wmx5vUt_JCQ2Mbzz4aaM";

    const sharePointBaseUrl = "https://hemascol.sharepoint.com";
    let editingItemId = null;
    let allItems = [];
    let currentStatusTab = ''; // empty means All

    const modal = new bootstrap.Modal(document.getElementById('itemModal'));

    function showToast(message, isError = false) {
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-bg-${isError ? 'danger' : 'success'} border-0 show`;
      toast.role = 'alert';
      toast.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div></div>`;
      document.querySelector('.toast-container').appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    async function fetchItems() {
      try {
        const res = await fetch(getItemsUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
        const data = await res.json();
        // Adjust path if needed depending on API structure
        return data?.d?.results || data?.results || [];
      } catch (err) {
        showToast('Failed to load items', true);
        return [];
      }
    }

    function getAttachmentLinks(item) {
      if (item.Attachments === true && item.AttachmentFiles?.results?.length > 0) {
        return item.AttachmentFiles.results.map(file => {
          const url = sharePointBaseUrl + encodeURI(file.ServerRelativeUrl);
          return `<a href="${url}" target="_blank" rel="noopener noreferrer">${file.FileName || 'Attachment'}</a>`;
        }).join(', ');
      }
      return '';
    }

    function buildTableBody(items) {
      const tbody = document.getElementById('tableBody');
      const emptyState = document.getElementById('emptyState');
      tbody.innerHTML = '';
      if (!items.length) {
        emptyState.style.display = 'block';
        return;
      } else {
        emptyState.style.display = 'none';
      }

      items.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.Title || ''}</td>
          <td>${item.Doctor || ''}</td>
          <td>${item.Status || ''}</td>
          <td>${getAttachmentLinks(item)}</td>
          <td>${item.Created ? new Date(item.Created).toLocaleString() : ''}</td>
        `;

        const tdActions = document.createElement('td');
        const btnEdit = document.createElement('button');
        btnEdit.className = 'btn btn-sm btn-warning';
        btnEdit.textContent = 'Edit';
        btnEdit.addEventListener('click', () => startEditItem(item));

        const btnDelete = document.createElement('button');
        btnDelete.className = 'btn btn-sm btn-danger ms-2';
        btnDelete.textContent = 'Delete';
        btnDelete.addEventListener('click', () => deleteItem(item.ID, item.Title));

        tdActions.appendChild(btnEdit);
        tdActions.appendChild(btnDelete);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      });
    }

    async function deleteItem(id, title) {
      if (!confirm(`Delete "${title}"?`)) return;
      try {
        const res = await fetch(deleteItemUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ID: id })
        });
        if (!res.ok) throw new Error('Delete failed');
        showToast('Deleted successfully');
        await loadData();
      } catch (err) {
        showToast('Delete error: ' + err.message, true);
      }
    }

    function startEditItem(item) {
      editingItemId = item.ID;
      document.getElementById('itemModalLabel').textContent = 'Edit Item';
      document.getElementById('inputTitle').value = item.Title || '';
      document.getElementById('inputDoctor').value = item.Doctor || '';
      document.getElementById('inputStatus').value = item.Status || '';
      document.getElementById('inputAttachment').value = ''; // Clear attachment input on edit
      modal.show();
    }

    async function submitForm(event) {
      event.preventDefault();

      const formData = {
        Title: document.getElementById('inputTitle').value.trim(),
        Doctor: document.getElementById('inputDoctor').value.trim(),
        Status: document.getElementById('inputStatus').value
      };
      if (!formData.Status) {
        showToast('Please select a status.', true);
        return;
      }

      if (editingItemId) formData.ID = editingItemId;

      try {
        const res = await fetch(editingItemId ? updateItemUrl : addItemUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(errorText || 'Save failed');
        }

        showToast(editingItemId ? 'Updated successfully' : 'Added successfully');
        editingItemId = null;
        modal.hide();
        document.getElementById('itemForm').reset();
        await loadData();
      } catch (err) {
        showToast('Save error: ' + err.message, true);
      }
    }

    function applyFiltersAndRender() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const filterStatus = document.getElementById('filterStatus').value;

      let filtered = allItems;

      // Filter by status tab
      if (currentStatusTab) {
        filtered = filtered.filter(item => (item.Status || '') === currentStatusTab);
      }

      // Filter by dropdown status (overrides tab if selected)
      if (filterStatus) {
        filtered = filtered.filter(item => (item.Status || '') === filterStatus);
      }

      // Filter by search term
      if (searchTerm) {
        filtered = filtered.filter(item => {
          const title = (item.Title || '').toLowerCase();
          const doctor = (item.Doctor || '').toLowerCase();
          return title.includes(searchTerm) || doctor.includes(searchTerm);
        });
      }

      buildTableBody(filtered);
    }

    async function loadData() {
      allItems = await fetchItems();
      applyFiltersAndRender();
    }

    // Event listeners
    document.getElementById('searchInput').addEventListener('input', applyFiltersAndRender);
    document.getElementById('filterStatus').addEventListener('change', applyFiltersAndRender);

    document.querySelectorAll('#statusTabs button').forEach(button => {
      button.addEventListener('click', () => {
        // Remove active class from all buttons
        document.querySelectorAll('#statusTabs button').forEach(btn => btn.classList.remove('active'));
        // Add active class to clicked tab
        button.classList.add('active');
        // Update currentStatusTab and re-render
        currentStatusTab = button.getAttribute('data-status');
        applyFiltersAndRender();

        // Clear dropdown filter when tab changes to avoid confusion
        document.getElementById('filterStatus').value = '';
      });
    });

    document.getElementById('btnRefresh').addEventListener('click', loadData);

    document.getElementById('btnAddNew').addEventListener('click', () => {
      editingItemId = null;
      document.getElementById('itemModalLabel').textContent = 'Add New Item';
      document.getElementById('itemForm').reset();
      modal.show();
    });

    document.getElementById('itemForm').addEventListener('submit', submitForm);

    window.onload = loadData;
  </script>
</body>
</html>
