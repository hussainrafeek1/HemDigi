<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fetch Attachments by PATID</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    input, button {
      padding: 10px;
      font-size: 16px;
      margin-right: 8px;
    }

    a {
      margin-bottom: 10px;
      display: inline-block;
      color: blue;
      cursor: pointer;
    }

    iframe {
      width: 100%;
      height: 500px;
      border: 1px solid #ccc;
      margin-top: 10px;
      display: none;
    }
  </style>
</head>
<body>
  <h2>üîç Search Patient Attachments</h2>

  <label for="patid">Enter PAT ID:</label>
  <input type="text" id="patid" placeholder="e.g., PAT123456" />
  <button onclick="fetchAttachments()">Search</button>

  <div id="output" style="margin-top: 20px;">Results will appear here...</div>

  <iframe id="pdfViewer"></iframe>

  <script>
    async function fetchAttachments() {
      const patid = document.getElementById("patid").value.trim();
      const outputDiv = document.getElementById("output");
      const iframe = document.getElementById("pdfViewer");
      iframe.style.display = "none";
      outputDiv.innerHTML = "‚è≥ Searching...";

      if (!patid) {
        outputDiv.innerHTML = "‚ùå Please enter a valid PAT ID.";
        return;
      }

      try {
        const response = await fetch("https://prod-30.southeastasia.logic.azure.com:443/workflows/6bc06d213f7741758434a4a4b810d52c/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=nmNPBbXp6hdyk0mR_SAUCunSGW9NnVXN2EEQmk4tA5c", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ "PATID": patid })
        });

        if (!response.ok) {
          throw new Error(`Server returned ${response.status}`);
        }

        const result = await response.json();

        if (!result.attachments || result.attachments.length === 0) {
          outputDiv.innerHTML = "‚ö†Ô∏è No attachments found for this PAT ID.";
          return;
        }

        outputDiv.innerHTML = `<strong>‚úÖ Found ${result.attachments.length} attachment(s):</strong><br/><br/>`;

        result.attachments.forEach((att, index) => {
          const fileName = att.FileName || `Attachment_${index + 1}.pdf`;
          const base64 = att.ContentBytes;

          const link = document.createElement("a");
          link.innerText = `üìÑ View ${fileName}`;
          link.onclick = () => {
            iframe.src = `data:application/pdf;base64,${base64}`;
            iframe.style.display = "block";
          };

          outputDiv.appendChild(link);
          outputDiv.appendChild(document.createElement("br"));
        });

      } catch (error) {
        console.error("Error:", error);
        outputDiv.innerHTML = "‚ùå Error fetching attachments. Please try again.";
      }
    }
  </script>
</body>
</html>
