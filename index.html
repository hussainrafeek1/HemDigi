<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Prescription Pad + PATID Attachments</title>
  <style>
    /* keep your original CSS styles for .custom-header, .pad-container, canvas, controls, etc. */
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
    /* Add PAT section styles below */
    #patSection { margin-top: 40px; }
    #patSection input, #patSection button { padding: 8px; font-size: 14px; margin-right: 6px; }
    #patSection a { display: block; margin: 5px 0; color: blue; cursor: pointer; }
    #patViewer { width:100%; height:400px; border:1px solid #ccc; margin-top:10px; display:none; }
  </style>
</head>
<body>

  <!-- === Your existing header and controls === -->
  <div class="custom-header"> ... </div>
  <div class="form-fields"> ... </div>
  <div class="pad-container">
    <!-- Prescription pad controls & canvas container -->
  </div>
  <div class="custom-footer"> ... </div>

  <!-- === New PATID Attachment Section === -->
  <div id="patSection">
    <h2>üîç Search Patient Attachments</h2>
    <label for="patid">Enter PAT ID:</label>
    <input type="text" id="patid" placeholder="e.g. PAT123456" />
    <button onclick="fetchAttachments()">Search</button>
    <div id="output" style="margin-top: 10px;">Results will appear here‚Ä¶</div>
    <iframe id="patViewer"></iframe>
  </div>

  <!-- === Scripts === -->
  <!-- include jsPDF and your existing pad script -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // ==== Your original prescription pad script here ====
    // functions: createCanvas, addPage, previousPage, clearCanvas,
    // toggleEraser, exportPDF, submitToSharePoint, generatePDF, onload, etc.

    // ==== New fetchAttachments section ====
    async function fetchAttachments() {
      const patid = document.getElementById("patid").value.trim();
      const output = document.getElementById("output");
      const iframe = document.getElementById("patViewer");
      iframe.style.display = 'none';
      output.innerHTML = '‚è≥ Searching...';

      if (!patid) {
        output.innerHTML = '‚ùå Please enter a valid PAT ID.';
        return;
      }

      try {
        const response = await fetch(
          'https://prod-30.southeastasia.logic.azure.com/...path...invoke?api-version=2016-06-01&sig=...', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ PATID: patid })
        });

        if (!response.ok) throw new Error('Server returned ' + response.status);
        const result = await response.json();

        if (!result.attachments || result.attachments.length === 0) {
          output.innerHTML = '‚ö†Ô∏è No attachments found for this PAT ID.';
          return;
        }

        output.innerHTML = `<strong>‚úÖ Found ${result.attachments.length} attachment(s):</strong><br/><br/>`;
        result.attachments.forEach((att, idx) => {
          const fileName = att.FileName || `Attachment_${idx+1}.pdf`;
          const base64 = att.ContentBytes;
          const link = document.createElement('a');
          link.innerText = `üìÑ View ${fileName}`;
          link.onclick = () => {
            iframe.src = `data:application/pdf;base64,${base64}`;
            iframe.style.display = 'block';
          };
          output.appendChild(link);
        });
      } catch (err) {
        console.error(err);
        output.innerHTML = '‚ùå Error fetching attachments. Please try again.';
      }
    }
  </script>
</body>
</html>
